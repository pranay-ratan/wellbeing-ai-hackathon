{% extends "base.html" %}

{% block title %}Team Wellbeing Dashboard - WellbeingAI{% endblock %}

{% block content %}
<div class="relative flex min-h-screen w-full">
<!-- SideNavBar -->
<aside class="flex h-screen w-64 flex-col bg-[#11221a] p-4 sticky top-0">
<div class="flex items-center gap-3 mb-8">
<span class="material-symbols-outlined text-primary text-3xl">health_and_safety</span>
<h2 class="text-white text-xl font-bold">WellbeingAI</h2>
</div>
<div class="flex flex-col gap-4 flex-grow">
<div class="flex flex-col gap-2">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-[#234836]" href="{{ url_for('manager_dashboard') }}">
<span class="material-symbols-outlined fill text-white">dashboard</span>
<p class="text-white text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors" href="#">
<span class="material-symbols-outlined text-white">bar_chart</span>
<p class="text-white text-sm font-medium leading-normal">Reports</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors" href="#">
<span class="material-symbols-outlined text-white">auto_awesome</span>
<p class="text-white text-sm font-medium leading-normal">Interventions</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors" href="#">
<span class="material-symbols-outlined text-white">toggle_on</span>
<p class="text-white text-sm font-medium leading-normal">Settings</p>
</a>
</div>
</div>
<div class="flex flex-col gap-1">
<div class="flex items-center gap-3 px-3 py-2 rounded-lg border border-[#32674d]">
<span class="material-symbols-outlined text-primary">privacy_tip</span>
<div class="flex flex-col">
<p class="text-white text-sm font-medium leading-normal">Privacy First</p>
<p class="text-[#92c9ad] text-xs">No individual data is exposed.</p>
</div>
</div>
<div class="mt-4 flex flex-col gap-2">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors" href="#">
<span class="material-symbols-outlined text-white">help</span>
<p class="text-white text-sm font-medium leading-normal">Help</p>
</a>
<div class="flex items-center gap-3 pt-4 border-t border-[#32674d]">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Admin profile picture" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDnhGdo-YOYgl6raOijswLXmz-_gPOj4l1HDeRAtIoo4fc-lqFRAaP-sjOJlBMaPceRhza75CouQlG0Iumzb_unBpu7tiL3n9FhBHQK7vNFRX2xjgUihi2NjPcY3xoXMBigc2C7a28_fWP_xUd8aICidRf7etTrqj-LSOxNMDDnY51wJWeR7BqsliXv5pkWzq5ASE5IF3redrjaDrhhdFmwWvRYX31e2Y6IXYHsVtpYWKYKUOOIpUP2nXfTN4SflIhu28vRM2o7-bs");'></div>
<div class="flex flex-col">
<h1 class="text-white text-base font-medium leading-normal">Manager Name</h1>
<p class="text-[#92c9ad] text-sm font-normal leading-normal">WellbeingAI Manager</p>
</div>
</div>
</div>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 p-8">
<div class="w-full max-w-7xl mx-auto">
<!-- Header -->
<header class="flex flex-wrap justify-between items-center gap-4 mb-6">
<div>
<p class="text-slate-500 dark:text-slate-400 text-sm">Welcome back,</p>
<h1 class="text-slate-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Team Wellbeing Dashboard</h1>
</div>
<div class="flex items-center gap-4">
<div class="relative">
<button class="flex items-center gap-2 text-slate-900 dark:text-white hover:text-primary dark:hover:text-primary transition-colors">
<span class="material-symbols-outlined">notifications</span>
<span class="absolute -top-1 -right-1 flex h-4 w-4">
<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
<span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 border-2 border-background-dark text-white text-xs items-center justify-center" id="notificationCount">1</span>
</span>
</button>
</div>
<div class="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
<button class="bg-primary text-slate-900 font-bold py-2 px-4 rounded-lg flex items-center gap-2 hover:opacity-90 transition-opacity" onclick="refreshDashboard()">
<span class="material-symbols-outlined">refresh</span>
                           Refresh Data
                        </button>
</div>
</header>
<!-- Filters -->
<div class="flex flex-wrap gap-3 mb-6">
<button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-white dark:bg-[#234836] pl-4 pr-2 border border-slate-200 dark:border-transparent">
<p class="text-slate-900 dark:text-white text-sm font-medium leading-normal">Date Range: Last 30 Days</p>
<span class="material-symbols-outlined text-slate-900 dark:text-white">expand_more</span>
</button>
<button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-white dark:bg-[#234836] pl-4 pr-2 border border-slate-200 dark:border-transparent">
<p class="text-slate-900 dark:text-white text-sm font-medium leading-normal">Group: All Departments</p>
<span class="material-symbols-outlined text-slate-900 dark:text-white">expand_more</span>
</button>
</div>
<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-[#11221a] border border-slate-200 dark:border-[#32674d]">
<p class="text-slate-600 dark:text-white text-base font-medium leading-normal">Active Users</p>
<p class="text-slate-900 dark:text-white tracking-light text-3xl font-bold leading-tight" id="activeUsers">482</p>
<p class="text-[#0bda46] text-base font-medium leading-normal" id="activeUsersChange">+5% vs last period</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-[#11221a] border border-slate-200 dark:border-[#32674d]">
<p class="text-slate-600 dark:text-white text-base font-medium leading-normal">Check-in Rate</p>
<p class="text-slate-900 dark:text-white tracking-light text-3xl font-bold leading-tight" id="checkinRate">85%</p>
<p class="text-[#fa5538] text-base font-medium leading-normal" id="checkinRateChange">-2% vs last period</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-[#11221a] border border-slate-200 dark:border-[#32674d]">
<p class="text-slate-600 dark:text-white text-base font-medium leading-normal">Org. Mood Score</p>
<p class="text-slate-900 dark:text-white tracking-light text-3xl font-bold leading-tight" id="orgMoodScore">7.2/10</p>
<p class="text-[#0bda46] text-base font-medium leading-normal" id="orgMoodScoreChange">+0.3 vs last period</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-[#11221a] border border-slate-200 dark:border-[#32674d]">
<p class="text-slate-600 dark:text-white text-base font-medium leading-normal">Users at Risk</p>
<p class="text-slate-900 dark:text-white tracking-light text-3xl font-bold leading-tight" id="usersAtRisk">12</p>
<p class="text-[#fa5538] text-base font-medium leading-normal" id="usersAtRiskChange">+2 vs last period</p>
</div>
</div>
<!-- Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
<!-- Main Charts Section -->
<div class="lg:col-span-3 flex flex-col gap-6">
<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-[#32674d] p-6 bg-white dark:bg-[#11221a]">
<p class="text-slate-900 dark:text-white text-lg font-bold leading-normal">Average Wellbeing by Department</p>
<div class="grid min-h-[250px] grid-flow-col gap-6 grid-rows-[1fr_auto] items-end justify-items-center px-3 pt-4" id="departmentChart">
<!-- Chart will be populated by JavaScript -->
</div>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-[#32674d] p-6 bg-white dark:bg-[#11221a]">
<p class="text-slate-900 dark:text-white text-lg font-bold leading-normal">Anonymized Risk Trend</p>
<p class="text-slate-500 dark:text-[#92c9ad] text-sm">This chart shows the number of users meeting at-risk criteria, not individuals.</p>
<div class="flex min-h-[250px] flex-1 flex-col gap-8 py-4" id="riskTrendChart">
<!-- Chart will be populated by JavaScript -->
</div>
</div>
</div>
<!-- Sidebar Section -->
<div class="lg:col-span-2 flex flex-col gap-6">
<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-[#32674d] p-6 bg-white dark:bg-[#11221a]">
<h3 class="text-slate-900 dark:text-white text-lg font-bold leading-normal">Top AI Recommendations</h3>
<ul class="flex flex-col gap-4" id="aiRecommendations">
<li class="flex items-start gap-4 p-4 rounded-lg bg-slate-100 dark:bg-slate-900/50">
<span class="material-symbols-outlined text-primary mt-1">lightbulb</span>
<p class="text-slate-700 dark:text-slate-300 text-sm">Promote flexible work hours this week to alleviate reported workload stress.</p>
</li>
<li class="flex items-start gap-4 p-4 rounded-lg bg-slate-100 dark:bg-slate-900/50">
<span class="material-symbols-outlined text-primary mt-1">lightbulb</span>
<p class="text-slate-700 dark:text-slate-300 text-sm">Share resources on managing project deadlines, focusing on the Engineering team.</p>
</li>
<li class="flex items-start gap-4 p-4 rounded-lg bg-slate-100 dark:bg-slate-900/50">
<span class="material-symbols-outlined text-primary mt-1">lightbulb</span>
<p class="text-slate-700 dark:text-slate-300 text-sm">Organize a non-work-related social event to boost team connection scores.</p>
</li>
</ul>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-[#32674d] p-6 bg-white dark:bg-[#11221a]">
<h3 class="text-slate-900 dark:text-white text-lg font-bold leading-normal">Wellness Goals</h3>
<div class="flex flex-col gap-4" id="wellnessGoals">
<div class="flex flex-col gap-2">
<div class="flex justify-between items-baseline">
<p class="text-slate-700 dark:text-slate-300 text-sm font-medium">Increase Check-in Rate</p>
<p class="text-slate-500 dark:text-slate-400 text-sm">75% of 90%</p>
</div>
<div class="w-full bg-slate-200 dark:bg-[#234836] rounded-full h-2.5">
<div class="bg-primary h-2.5 rounded-full" style="width: 75%"></div>
</div>
</div>
<div class="flex flex-col gap-2">
<div class="flex justify-between items-baseline">
<p class="text-slate-700 dark:text-slate-300 text-sm font-medium">Improve Org. Mood Score</p>
<p class="text-slate-500 dark:text-slate-400 text-sm">7.2 of 8.0</p>
</div>
<div class="w-full bg-slate-200 dark:bg-[#234836] rounded-full h-2.5">
<div class="bg-primary h-2.5 rounded-full" style="width: 90%"></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let departmentChart = null;
let riskTrendChart = null;

async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard/manager');
        const data = await response.json();

        if (data.error) {
            console.error('Failed to load dashboard data:', data.error);
            return;
        }

        updateDashboard(data);
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function updateDashboard(data) {
    // Update stats
    updateStats(data);

    // Update charts
    updateDepartmentChart(data);
    updateRiskTrendChart(data);

    // Update recommendations and goals
    updateRecommendations(data);
    updateWellnessGoals(data);
}

function updateStats(data) {
    const teamStats = data.team_stats || {};

    document.getElementById('activeUsers').textContent = teamStats.total_members || 482;
    document.getElementById('activeUsersChange').textContent = teamStats.active_change || '+5% vs last period';

    document.getElementById('checkinRate').textContent = teamStats.checkin_rate ? `${teamStats.checkin_rate}%` : '85%';
    document.getElementById('checkinRateChange').textContent = teamStats.checkin_change || '-2% vs last period';

    document.getElementById('orgMoodScore').textContent = teamStats.avg_mood ? `${teamStats.avg_mood.toFixed(1)}/10` : '7.2/10';
    document.getElementById('orgMoodScoreChange').textContent = teamStats.mood_change || '+0.3 vs last period';

    document.getElementById('usersAtRisk').textContent = teamStats.high_risk_count || 12;
    document.getElementById('usersAtRiskChange').textContent = teamStats.risk_change || '+2 vs last period';
}

function updateDepartmentChart(data) {
    const container = document.getElementById('departmentChart');
    const moodData = data.mood_distribution || {};

    // Mock department data for demo
    const departments = [
        { name: 'Engineering', value: 60 },
        { name: 'Marketing', value: 100 },
        { name: 'Sales', value: 20 },
        { name: 'Design', value: 70 },
        { name: 'HR', value: 50 }
    ];

    container.innerHTML = '';

    departments.forEach(dept => {
        const bar = document.createElement('div');
        bar.className = 'bg-primary/20 dark:bg-[#234836] w-full rounded-t-md';
        bar.style.height = `${dept.value}%`;

        const label = document.createElement('p');
        label.className = 'text-slate-500 dark:text-[#92c9ad] text-[13px] font-bold leading-normal tracking-[0.015em]';
        label.textContent = dept.name;

        container.appendChild(bar);
        container.appendChild(label);
    });
}

function updateRiskTrendChart(data) {
    const container = document.getElementById('riskTrendChart');

    // Create SVG risk trend chart
    container.innerHTML = `
        <svg fill="none" height="100%" preserveaspectratio="none" viewbox="0 0 475 150" width="100%" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z" fill="url(#paint0_linear)"></path>
            <path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25" stroke="#13ec80" stroke-linecap="round" stroke-width="3"></path>
            <defs>
                <lineargradient gradientunits="userSpaceOnUse" id="paint0_linear" x1="236" x2="236" y1="1" y2="149">
                    <stop stop-color="#13ec80" stop-opacity="0.2"></stop>
                    <stop offset="1" stop-color="#13ec80" stop-opacity="0"></stop>
                </lineargradient>
            </defs>
        </svg>
        <div class="flex justify-around">
            <p class="text-slate-500 dark:text-[#92c9ad] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 1</p>
            <p class="text-slate-500 dark:text-[#92c9ad] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 2</p>
            <p class="text-slate-500 dark:text-[#92c9ad] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 3</p>
            <p class="text-slate-500 dark:text-[#92c9ad] text-[13px] font-bold leading-normal tracking-[0.015em]">Week 4</p>
        </div>
    `;
}

function updateRecommendations(data) {
    const insights = data.team_insights || [
        "Promote flexible work hours this week to alleviate reported workload stress.",
        "Share resources on managing project deadlines, focusing on the Engineering team.",
        "Organize a non-work-related social event to boost team connection scores."
    ];

    const container = document.getElementById('aiRecommendations');
    container.innerHTML = '';

    insights.forEach(insight => {
        const li = document.createElement('li');
        li.className = 'flex items-start gap-4 p-4 rounded-lg bg-slate-100 dark:bg-slate-900/50';
        li.innerHTML = `
            <span class="material-symbols-outlined text-primary mt-1">lightbulb</span>
            <p class="text-slate-700 dark:text-slate-300 text-sm">${insight}</p>
        `;
        container.appendChild(li);
    });
}

function updateWellnessGoals(data) {
    // Mock wellness goals for demo
    const goals = [
        { name: 'Increase Check-in Rate', current: 75, target: 90 },
        { name: 'Improve Org. Mood Score', current: 7.2, target: 8.0 }
    ];

    const container = document.getElementById('wellnessGoals');
    container.innerHTML = '';

    goals.forEach(goal => {
        const percentage = (goal.current / goal.target) * 100;
        const div = document.createElement('div');
        div.className = 'flex flex-col gap-2';
        div.innerHTML = `
            <div class="flex justify-between items-baseline">
                <p class="text-slate-700 dark:text-slate-300 text-sm font-medium">${goal.name}</p>
                <p class="text-slate-500 dark:text-slate-400 text-sm">${goal.current} of ${goal.target}</p>
            </div>
            <div class="w-full bg-slate-200 dark:bg-[#234836] rounded-full h-2.5">
                <div class="bg-primary h-2.5 rounded-full" style="width: ${percentage}%"></div>
            </div>
        `;
        container.appendChild(div);
    });
}

function refreshDashboard() {
    loadDashboardData();
}

// Load dashboard on page load
document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}
